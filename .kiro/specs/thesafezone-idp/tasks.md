# Implementation Plan

- [x] 1. Set up project structure and CDK infrastructure foundation
  - [x] 1.1 Initialize CDK TypeScript project with required dependencies
    - Set up AWS CDK project structure
    - Configure TypeScript, ESLint, and testing framework (Jest + fast-check)
    - Add dependencies: aws-cdk-lib, constructs, @aws-sdk/client-cognito-identity-provider, @aws-sdk/client-dynamodb, fast-check, aws-jwt-verify
    - _Requirements: 1.1, 1.2_
  - [x] 1.2 Create Cognito User Pool with custom attributes and security settings
    - Configure User Pool with email/password authentication
    - Add custom attributes: displayName, firstName, lastName, interests
    - Configure password policy and account recovery
    - Set token validity: access token 1 hour, refresh token 30 days
    - Enable advanced security for account lockout (5 attempts, 15 min)
    - _Requirements: 2.1, 6.1, 11.1, 13.1_
  - [x] 1.3 Configure Google federation in User Pool
    - Set up Google as identity provider
    - Configure attribute mapping from Google claims
    - _Requirements: 3.1, 3.2_
  - [x] 1.4 Create Cognito Identity Pool for anonymous authentication
    - Configure unauthenticated identity support
    - Link to User Pool for authenticated identities
    - _Requirements: 4.1, 4.2_
  - [x] 1.5 Create User Pool App Clients for each client type
    - Create public client for web/mobile (PKCE required, no secret)
    - Create public client for VR (Device Code flow)
    - Create public client for sample-client demo app
    - Configure scopes and callback URLs per client
    - _Requirements: 10.1, 10.2, 10.3, 10.4_
  - [x] 1.6 Create DynamoDB table for Device Code storage
    - Create table with deviceCode as partition key
    - Add GSI on userCode for lookup
    - Configure TTL on ttl attribute
    - _Requirements: 9.1, 9.2_

- [x] 2. Implement Device Code Lambda (RFC 8628)
  - [x] 2.1 Implement POST /device/code endpoint
    - Generate unique device_code and user_code
    - Store in DynamoDB with 10-minute expiration
    - Return verification_uri and polling interval
    - _Requirements: 9.1, 9.2_
  - [x] 2.2 Write property test for Device Code Format and Expiration
    - **Property 15: Device Code Format and Expiration**
    - **Validates: Requirements 9.1, 9.2**
  - [x] 2.3 Implement POST /device/token endpoint (polling)
    - Return authorization_pending for pending codes
    - Return tokens for authorized codes
    - Return expired_token for expired codes
    - _Requirements: 9.4, 9.5_
  - [x] 2.4 Write property test for Device Code Polling States
    - **Property 16: Device Code Polling States**
    - **Validates: Requirements 9.4, 9.5**
  - [x] 2.5 Implement POST /device/authorize endpoint
    - Validate user authentication via access token
    - Store tokens in DynamoDB record
    - Update status to authorized
    - _Requirements: 9.3, 9.4_

- [x] 3. Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.

- [x] 4. Configure Cognito Managed Login and build sample client
  - [x] 4.1 Configure Cognito Managed Login branding
    - Configure Cognito domain for /oauth2 endpoints
    - Set up Managed Login UI customization (logo, colors) via AWS Console or CDK
    - Ensure responsive design is handled by Cognito's built-in UI
    - _Requirements: 12.1, 12.3, 12.4_
  - [x] 4.2 Build sample client application
    - Create a standalone demo app that initiates OIDC login flow
    - Implement PKCE utilities: code_verifier generation and code_challenge computation (S256)
    - Redirect to Cognito /oauth2/authorize endpoint (Managed Login handles authentication)
    - After successful authentication, display user profile information (displayName, firstName, lastName, email, interests)
    - Display token information (access token expiry, ID token claims, refresh token status)
    - Include logout functionality
    - _Requirements: 1.1, 1.4, 10.4, 12.1_
  - [x] 4.3 Write property test for PKCE Validation
    - **Property 1: PKCE Validation**
    - **Validates: Requirements 1.1**

- [x] 5. Implement Device Activation Flow for VR
  - [x] 5.1 Create device activation web page
    - Simple page at /activate that accepts user_code
    - Validate user_code via API Gateway /device/authorize
    - Redirect to Cognito /oauth2/authorize for authentication
    - After auth, call /device/authorize to complete device authorization
    - _Requirements: 9.3_

- [x] 6. Deploy infrastructure with CDK
  - [x] 6.1 Deploy Cognito resources
    - Deploy User Pool and Identity Pool
    - Configure Cognito domain for /oauth2 endpoints
    - Configure Managed Login branding
    - _Requirements: 1.4, 1.5, 12.1_
  - [x] 6.2 Deploy API Gateway and Device Code Lambda
    - Deploy Device Code Lambda
    - Configure API Gateway routes for /device/code, /device/token, /device/authorize
    - _Requirements: 9.1_
  - [x] 6.3 Deploy device activation page
    - Deploy S3 bucket for static activation page
    - Configure CloudFront distribution
    - _Requirements: 9.3_

- [ ] 7. Deploy Sample Client Application
  - [x] 7.1 Create S3 bucket and CloudFront distribution for sample client
    - Create S3 bucket for static hosting with private access
    - Create CloudFront distribution with Origin Access Control
    - Configure HTTPS with CloudFront default certificate
    - Set up proper cache behaviors for static assets
    - _Requirements: 15.1_
  - [x] 7.2 Configure sample client build with Cognito endpoints
    - Update sample client environment variables with deployed Cognito domain and client ID
    - Configure redirect URIs to use CloudFront distribution URL
    - Build sample client with production configuration
    - _Requirements: 15.2_
  - [ ] 7.3 Deploy sample client assets to S3
    - Upload built assets to S3 bucket
    - Configure CloudFront cache invalidation for updates
    - _Requirements: 15.4_
  - [x] 7.4 Update Cognito App Client with sample client callback URLs
    - Add CloudFront distribution URL to allowed callback URLs
    - Add CloudFront distribution URL to allowed logout URLs
    - _Requirements: 15.3_

- [ ] 8. Final Checkpoint - Ensure all tests pass
  - Ensure all tests pass, ask the user if questions arise.
